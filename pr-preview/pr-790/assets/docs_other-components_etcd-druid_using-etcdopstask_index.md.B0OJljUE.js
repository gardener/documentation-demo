import{_ as e,c as a,o as i,a2 as t}from"./chunks/framework.Gi3Q71dA.js";const k=JSON.parse('{"title":"Using Etcdopstask","description":"","frontmatter":{"github_repo":"https://github.com/gardener/etcd-druid","github_subdir":"docs/usage","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/other-components/etcd-druid/using-etcdopstask.md","to":"using-etcdopstask.md"},"persona":"Users","title":"Using Etcdopstask","prev":false,"next":false},"headers":[],"relativePath":"docs/other-components/etcd-druid/using-etcdopstask/index.md","filePath":"docs/other-components/etcd-druid/using-etcdopstask.md","lastUpdated":null}'),n={name:"docs/other-components/etcd-druid/using-etcdopstask/index.md"};function l(o,s,p,r,d,h){return i(),a("div",null,s[0]||(s[0]=[t(`<h1 id="using-etcdopstask" tabindex="-1">Using EtcdOpsTask <a class="header-anchor" href="#using-etcdopstask" aria-label="Permalink to &quot;Using EtcdOpsTask&quot;">​</a></h1><p><code>EtcdOpsTask</code> is a custom resource provided by the etcd-druid to facilitate various out-of-band tasks on Etcd clusters managed by the etcd-druid operator. It was initially proposed in <a href="/pr-preview/pr-790/docs/other-components/etcd-druid/proposals/05-etcdopstask/">this design document</a>.</p><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p><code>EtcdOpsTask</code> allows operators to execute one-time operational tasks on an Etcd cluster. This includes operations like triggering on-demand snapshots (full or delta). The controller manages the task lifecycle, executing the operation and updating the task status to reflect success or failure.</p><h2 id="how-operators-can-use-etcdopstask" tabindex="-1">How Operators Can Use EtcdOpsTask <a class="header-anchor" href="#how-operators-can-use-etcdopstask" aria-label="Permalink to &quot;How Operators Can Use EtcdOpsTask&quot;">​</a></h2><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p>As of v0.34.0, <code>EtcdOpsTask</code> primarily supports on-demand snapshot operations. Future versions may introduce additional task types.</p></div><h3 id="creating-an-etcdopstask" tabindex="-1">Creating an EtcdOpsTask <a class="header-anchor" href="#creating-an-etcdopstask" aria-label="Permalink to &quot;Creating an EtcdOpsTask&quot;">​</a></h3><p>To trigger an operational task, create an <code>EtcdOpsTask</code> resource in the same namespace as the target Etcd cluster. The <code>spec.config</code> field specifies the type of operation to perform. This field is of union type, allowing one and only one operation to be defined per task:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">druid.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EtcdOpsTask</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">on-demand-snapshot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  etcdName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-main</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    onDemandSnapshot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">full</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # or delta</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      #isFinal: false</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      timeoutSecondsFull</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">480</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      #timeoutSecondsDelta: 60</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">   ttlSecondsAfterFinished</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">360</span></span></code></pre></div><ul><li>The above example creates an <code>EtcdOpsTask</code> named <code>on-demand-snapshot</code> that triggers an on-demand snapshot for the Etcd cluster referenced by <code>spec.etcdName</code> in the <code>metadata.namespace</code> namespace where the <code>EtcdOpstask</code> is created. Some tasks might not require an etcd reference and hence the field <code>spec.etcdName</code> is optional.</li><li>The task will be automatically deleted after a Time-To-Live duration (TTL) completion as defined by <code>spec.ttlSecondsAfterFinished</code>. If not specified, the default TTL is 3600 seconds (1 hour).</li><li>The spec field is immutable and is enforced via <a href="https://kubernetes.io/docs/reference/using-api/cel/" target="_blank" rel="noreferrer"><code>CEL</code></a> expressions.</li></ul><h3 id="task-lifecycle" tabindex="-1">Task Lifecycle <a class="header-anchor" href="#task-lifecycle" aria-label="Permalink to &quot;Task Lifecycle&quot;">​</a></h3><p>Once created, the <code>EtcdOpsTask</code> progresses through the following states:</p><ol><li><strong>Pending</strong>: Task is accepted but not yet acted upon</li><li><strong>InProgress</strong>: Task is currently being executed</li><li><strong>Succeeded</strong>: Task completed successfully</li><li><strong>Failed</strong>: Task execution failed.</li><li><strong>Rejected</strong>: Task was rejected as it failed to fulfill required pre-conditions. This set of pre-conditions varies from task to task.</li></ol><p>Once a task reaches a terminal state (Succeeded, Failed, or Rejected), it will be eligible for automatic cleanup based on the specified TTL(<code>spec.ttlSecondsAfterFinished</code>).</p><h4 id="task-phases" tabindex="-1">Task Phases <a class="header-anchor" href="#task-phases" aria-label="Permalink to &quot;Task Phases&quot;">​</a></h4><p>The <code>Etcdopstask</code> controller follows a handler-driven flow with three phases:</p><ul><li><strong>Admit</strong>: Validates preconditions (RBAC, duplicates, config). Task moves <code>Pending → InProgress</code> on success, or <code>Rejected</code> on failure.</li><li><strong>Execute</strong>: Performs the requested operation (e.g., on-demand snapshot). Task transitions to <code>Succeeded</code> or <code>Failed</code>.</li><li><strong>Cleanup</strong>: Handles cleanup of the task and any deployed resources. <code>EtcdopsTask</code> resource is deleted after TTL expiry.</li></ul><h3 id="monitoring-task-status" tabindex="-1">Monitoring Task Status <a class="header-anchor" href="#monitoring-task-status" aria-label="Permalink to &quot;Monitoring Task Status&quot;">​</a></h3><p>Check the task status to monitor progress:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> etcdopstask</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcdopstask</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yaml</span></span></code></pre></div><p>The status section provides:</p><ul><li><strong>State</strong>: Current task <a href="/pr-preview/pr-790/docs/other-components/etcd-druid/using-etcdopstask/#task-lifecycle">state</a></li><li><strong>LastOperation</strong>: Last reconciliation operation performed <ul><li><strong>Type</strong>: Type of operation i.e whether it is in the Admit phase or Execute phase or Cleanup phase</li><li><strong>State</strong>: State of the last operation type. A combination of Type and State can help identify the status of the operation. Eg: <ul><li>Type: Execute, State: Failed indicates that the task execution has failed</li><li>Type: Admit, State: InProgress indicates that the task is running the pre-conditions.</li></ul></li><li><strong>RunID</strong>: Unique identifier for the operation run</li><li><strong>LastUpdateTime</strong>: Timestamp of the last update to the LastOperation field</li></ul></li><li><strong>LastError</strong>: Error details if any while running the LastOperation. <ul><li><strong>Code</strong>: Error code</li><li><strong>Description</strong>: Detailed error message</li><li><strong>ObservedAt</strong>: Timestamp when the error was observed</li></ul></li><li><strong>LastTransitionTime</strong>: Timestamp of the last state transition</li><li><strong>StartedAt</strong>: Timestamp when the task execution started</li></ul><p>Example status:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  state</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">InProgress</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  lastTransitionTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-12-03T23:31:38Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  startedAt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-12-03T23:31:32Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  lastOperation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Task Execution phase is in Progress</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    lastUpdateTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-12-03T23:31:50Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    runID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">e094cd10-e756-4132-b52a-50c164d1df2a</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    state</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">InProgress</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Execute</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">   lastErrors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ERR_EXECUTE_HTTP_REQUEST</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">     description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;[Operation: Execution, Code: ERR_EXECUTE_HTTP_REQUEST] message:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        failed to execute HTTP request, cause: Post &quot;http://etcd-test-client.default:8080/snapshot/full&quot;:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        dial tcp 10.96.99.172:8080: connect: connection refused&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">     observedAt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-12-03T23:31:53Z&quot;</span></span></code></pre></div><h3 id="task-cleanup" tabindex="-1">Task Cleanup <a class="header-anchor" href="#task-cleanup" aria-label="Permalink to &quot;Task Cleanup&quot;">​</a></h3><p><code>EtcdOpsTask</code> resources along with any dependent resources (Eg: Jobs, Pods etc.) are automatically cleaned up after a configurable TTL once they reach a terminal state (Succeeded, Failed, or Rejected).</p><h3 id="supported-task-types" tabindex="-1">Supported Task Types <a class="header-anchor" href="#supported-task-types" aria-label="Permalink to &quot;Supported Task Types&quot;">​</a></h3><p>Currently supported task types:</p><h4 id="ondemandsnapshot" tabindex="-1">OnDemandSnapshot <a class="header-anchor" href="#ondemandsnapshot" aria-label="Permalink to &quot;OnDemandSnapshot&quot;">​</a></h4><p>Triggers an on-demand snapshot outside the regular snapshot schedule.</p><p><strong>Snapshot Types:</strong></p><ul><li><strong>Full</strong>: Creates a complete snapshot of the entire Etcd data store.</li><li><strong>Delta</strong>: Creates an incremental snapshot containing only the changes since the last snapshot.</li></ul><p><strong>Prerequisites:</strong></p><ul><li>Backup must be enabled for the target Etcd cluster (<code>spec.backup.store</code> must be configured in the Etcd resource)</li><li>The Etcd cluster must be in a ready state (all members healthy and running)</li><li>No other <code>EtcdOpsTask</code> should be in progress for the same Etcd cluster.</li></ul><p><strong>Configuration Options:</strong></p><ul><li><code>type</code>: Specifies the snapshot type (<code>full</code> or <code>delta</code>)</li><li><code>isFinal</code>: Optional boolean flag to mark the snapshot as final (default: <code>false</code>). This field is applicable only for full snapshots.</li><li><code>timeoutSecondsFull</code>: Timeout in seconds for full snapshot operations (default: 480)</li><li><code>timeoutSecondsDelta</code>: Timeout in seconds for delta snapshot operations (default: 60)</li></ul><h3 id="best-practices" tabindex="-1">Best Practices <a class="header-anchor" href="#best-practices" aria-label="Permalink to &quot;Best Practices&quot;">​</a></h3><ol><li><strong>Unique Names</strong>: Use descriptive, unique names for tasks to avoid conflicts</li><li><strong>Monitor Status</strong>: Check task status before creating duplicate operations. This will help avoid duplicate tasks.</li></ol>`,38)]))}const u=e(n,[["render",l]]);export{k as __pageData,u as default};
