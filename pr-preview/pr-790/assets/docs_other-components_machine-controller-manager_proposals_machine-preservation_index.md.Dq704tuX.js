import{_ as a,c as i,o as s,a2 as n}from"./chunks/framework.Gi3Q71dA.js";const u=JSON.parse('{"title":"Machine Preservation","description":"","frontmatter":{"github_repo":"https://github.com/gardener/machine-controller-manager","github_subdir":"docs/proposals","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/other-components/machine-controller-manager/proposals/machine-preservation.md","to":"machine-preservation.md"},"title":"Machine Preservation","prev":false,"next":false},"headers":[],"relativePath":"docs/other-components/machine-controller-manager/proposals/machine-preservation/index.md","filePath":"docs/other-components/machine-controller-manager/proposals/machine-preservation.md","lastUpdated":null}'),o={name:"docs/other-components/machine-controller-manager/proposals/machine-preservation/index.md"};function t(r,e,l,d,c,h){return s(),i("div",null,e[0]||(e[0]=[n(`<h1 id="preservation-of-machines" tabindex="-1">Preservation of Machines <a class="header-anchor" href="#preservation-of-machines" aria-label="Permalink to &quot;Preservation of Machines&quot;">​</a></h1><ul><li><a href="/pr-preview/pr-790/docs/other-components/machine-controller-manager/proposals/machine-preservation/#preservation-of-machines">Preservation of Machines</a><ul><li><a href="/pr-preview/pr-790/docs/other-components/machine-controller-manager/proposals/machine-preservation/#objective">Objective</a></li><li><a href="/pr-preview/pr-790/docs/other-components/machine-controller-manager/proposals/machine-preservation/#proposal">Proposal</a></li><li><a href="/pr-preview/pr-790/docs/other-components/machine-controller-manager/proposals/machine-preservation/#state-diagrams">State Diagrams</a></li><li><a href="/pr-preview/pr-790/docs/other-components/machine-controller-manager/proposals/machine-preservation/#use-cases">Use Cases</a></li></ul></li></ul><h2 id="objective" tabindex="-1">Objective <a class="header-anchor" href="#objective" aria-label="Permalink to &quot;Objective&quot;">​</a></h2><p>Currently, the Machine Controller Manager(MCM) moves Machines with errors to the <code>Unknown</code> phase, and after the configured <code>machineHealthTimeout</code>, to the <code>Failed</code> phase. <code>Failed</code> machines are swiftly moved to the <code>Terminating</code> phase during which the node is drained and the <code>Machine</code> object is deleted. This rapid cleanup prevents SRE/operators/support from conducting an analysis on the VM and makes finding root cause of failure more difficult.</p><p>Moreover, in cases where a node seems healthy but all the workload on it are facing issues, there is a need for operators to be able to cordon/drain the node and conduct their analysis without the cluster-autoscaler (CA) scaling down the node.</p><p>This document proposes enhancing MCM, such that:</p><ul><li>VMs of machines are retained temporarily for analysis.</li><li>There is a configurable limit to the number of machines that can be preserved automatically on failure (auto-preservation).</li><li>There is a configurable limit to the duration for which machines are preserved.</li><li>Users can specify which healthy machines they would like to preserve in case of failure, or for diagnoses in current state (prevent scale down by CA).</li><li>Users can request MCM to release a preserved machine, even before the timeout expires, so that MCM can transition the machine to either <code>Running</code> or <code>Terminating</code> phase, as the case may be.</li></ul><p>Related Issue: <a href="https://github.com/gardener/machine-controller-manager/issues/1008" target="_blank" rel="noreferrer">https://github.com/gardener/machine-controller-manager/issues/1008</a></p><h2 id="proposal" tabindex="-1">Proposal <a class="header-anchor" href="#proposal" aria-label="Permalink to &quot;Proposal&quot;">​</a></h2><p>In order to achieve the objectives mentioned, the following are proposed:</p><ol><li>Enhance <code>machineControllerManager</code> configuration in the <code>ShootSpec</code>, to specify the max number of machines to be auto-preserved, and the time duration for which these machines will be preserved.<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>machineControllerManager:</span></span>
<span class="line"><span>   autoPreserveFailedMax: 0</span></span>
<span class="line"><span>   machinePreserveTimeout: 72h</span></span></code></pre></div><ul><li>This configuration will be set per worker pool.</li><li>Since gardener worker pool can correspond to <code>1..N</code> MachineDeployments depending on number of zones, <code>autoPreserveFailedMax</code> will be distributed across N machine deployments.</li><li><code>autoPreserveFailedMax</code> must be chosen such that it can be appropriately distributed across the MachineDeployments.</li><li>Example: if <code>autoPreserveFailedMax</code> is set to 2, and the worker pool has 2 zones, then the maximum number of machines that will be preserved per zone is 1.</li></ul></li><li>MCM will be modified to include a new sub-phase <code>Preserved</code> to indicate that the machine has been preserved by MCM.</li><li>Allow user/operator to request for preservation of a specific machine/node with the use of annotations : <code>node.machine.sapcloud.io/preserve=now</code> and <code>node.machine.sapcloud.io/preserve=when-failed</code>.</li><li>When annotation <code>node.machine.sapcloud.io/preserve=now</code> is added to a <code>Running</code> machine, the following will take place: <ul><li><code>cluster-autoscaler.kubernetes.io/scale-down-disabled: &quot;true&quot;</code> is added to the node to prevent CA from scaling it down.</li><li><code>machine.CurrentStatus.PreserveExpiryTime</code> is updated by MCM as $machine.CurrentStatus.PreserveExpiryTime = currentTime+machinePreserveTimeout$.</li><li>The machine&#39;s phase is changed to <code>Running:Preserved</code>.</li><li>After timeout, the <code>node.machine.sapcloud.io/preserve=now</code> and <code>cluster-autoscaler.kubernetes.io/scale-down-disabled: &quot;true&quot;</code> are deleted. The <code>machine.CurrentStatus.PreserveExpiryTime</code> is set to <code>nil</code>. The machine phase is changed to <code>Running</code> and the CA may delete the node. <ul><li>If a machine in <code>Running:Preserved</code> fails, it is moved to <code>Failed:Preserved</code>.</li></ul></li></ul></li><li>When annotation <code>node.machine.sapcloud.io/preserve=when-failed</code> is added to a <code>Running</code> machine and the machine goes to <code>Failed</code>, the following will take place: <ul><li>The machine is drained of pods except for Daemonset pods.</li><li>The machine phase is changed to <code>Failed:Preserved</code>.</li><li><code>cluster-autoscaler.kubernetes.io/scale-down-disabled: &quot;true&quot;</code> is added to the node to prevent CA from scaling it down.</li><li><code>machine.CurrentStatus.PreserveExpiryTime</code> is updated by MCM as $machine.CurrentStatus.PreserveExpiryTime = currentTime+machinePreserveTimeout$.</li><li>After timeout, the annotations <code>node.machine.sapcloud.io/preserve=when-failed</code> and <code>cluster-autoscaler.kubernetes.io/scale-down-disabled: &quot;true&quot;</code> are deleted. <code>machine.CurrentStatus.PreserveExpiryTime</code> is set to <code>nil</code>. The phase is changed to <code>Terminating</code>.</li></ul></li><li>When an un-annotated machine goes to <code>Failed</code> phase and <code>autoPreserveFailedMax</code> is not breached: <ul><li>Pods (other than DaemonSet pods) are drained.</li><li>The machine&#39;s phase is changed to <code>Failed:Preserved</code>.</li><li><code>cluster-autoscaler.kubernetes.io/scale-down-disabled: &quot;true&quot;</code> is added to the node to prevent CA from scaling it down.</li><li><code>machine.CurrentStatus.PreserveExpiryTime</code> is updated by MCM as $machine.CurrentStatus.PreserveExpiryTime = currentTime+machinePreserveTimeout$.</li><li>After timeout, the annotation <code>cluster-autoscaler.kubernetes.io/scale-down-disabled: &quot;true&quot;</code> is deleted. <code>machine.CurrentStatus.PreserveExpiryTime</code> is set to <code>nil</code>. The phase is changed to <code>Terminating</code>.</li><li>Number of machines in <code>Failed:Preserved</code> phase count towards enforcing <code>autoPreserveFailedMax</code>.</li></ul></li><li>If a failed machine is currently in <code>Failed:Preserved</code> and before timeout its VM/node is found to be Healthy, the machine will be moved to <code>Running:Preserved</code>. After the timeout, it will be moved to <code>Running</code>. The rationale behind moving the machine to <code>Running:Preserved</code> rather than <code>Running</code>, is to allow pods to get scheduled on to the healthy node again without the autoscaler scaling it down due to under-utilization.</li><li>A user/operator can request MCM to stop preserving a machine/node in <code>Running:Preserved</code> or <code>Failed:Preserved</code> phase using the annotation: <code>node.machine.sapcloud.io/preserve=false</code>. <ul><li>MCM will move a machine thus annotated either to <code>Running</code> phase or <code>Terminating</code> depending on the phase of the machine before it was preserved.</li></ul></li><li>Machines of a MachineDeployment in <code>Preserved</code> sub-phase will also be counted towards the replica count and in the enforcement of maximum machines allowed for the MachineDeployment.</li><li>MCM will be modified to perform drain in <code>Failed</code> phase rather than <code>Terminating</code>.</li></ol><h2 id="state-diagrams" tabindex="-1">State Diagrams: <a class="header-anchor" href="#state-diagrams" aria-label="Permalink to &quot;State Diagrams:&quot;">​</a></h2><ol><li>State Diagram for when a machine or its node is explicitly annotated for preservation:<div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">stateDiagram-v2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state &quot;Running&quot; as R</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state &quot;Running + Requested&quot; as RR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state &quot;Running:Preserved&quot; as RP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state &quot;Failed</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    (node drained)&quot; as F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state &quot;Failed:Preserved&quot; as FP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state &quot;Terminating&quot; as T</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [*]--&gt;R</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    R --&gt; RR: annotated with preserve=when-failed</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    RP--&gt;R: on timeout or preserve=false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    RR --&gt; F: on failure</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    F --&gt; FP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    FP --&gt; T: on timeout or preserve=false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    FP --&gt; RP: if node Healthy before timeout</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    T --&gt; [*]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    R--&gt;RP: annotated with preserve=now</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    RP--&gt;F: if node/VM not healthy</span></span></code></pre></div></li><li>State Diagram for when an un-annotated <code>Running</code> machine fails (Auto-preservation):<div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">stateDiagram-v2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state &quot;Running&quot; as R</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state &quot;Running:Preserved&quot; as RP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state &quot;Failed</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    (node drained)&quot; as F</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state &quot;Failed:Preserved&quot; as FP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state &quot;Terminating&quot; as T</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [*] --&gt; R</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    R--&gt;F: on failure</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    F --&gt; FP: if autoPreserveFailedMax not breached</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    F --&gt; T: if autoPreserveFailedMax breached</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    FP --&gt; T: on timeout or value=false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    FP --&gt; RP : if node Healthy before timeout</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    RP --&gt; R: on timeout or preserve=false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    T --&gt; [*]</span></span></code></pre></div></li></ol><h2 id="use-cases" tabindex="-1">Use Cases: <a class="header-anchor" href="#use-cases" aria-label="Permalink to &quot;Use Cases:&quot;">​</a></h2><h3 id="use-case-1-preservation-request-for-analysing-running-machine" tabindex="-1">Use Case 1: Preservation Request for Analysing Running Machine <a class="header-anchor" href="#use-case-1-preservation-request-for-analysing-running-machine" aria-label="Permalink to &quot;Use Case 1: Preservation Request for Analysing Running Machine&quot;">​</a></h3><p><strong>Scenario:</strong> Workload on machine failing. Operator wishes to diagnose.</p><h4 id="steps" tabindex="-1">Steps: <a class="header-anchor" href="#steps" aria-label="Permalink to &quot;Steps:&quot;">​</a></h4><ol><li>Operator annotates node with <code>node.machine.sapcloud.io/preserve=now</code>.</li><li>MCM preserves the machine, and prevents CA from scaling it down.</li><li>Operator analyzes the VM.</li></ol><h3 id="use-case-2-proactive-preservation-request" tabindex="-1">Use Case 2: Proactive Preservation Request <a class="header-anchor" href="#use-case-2-proactive-preservation-request" aria-label="Permalink to &quot;Use Case 2: Proactive Preservation Request&quot;">​</a></h3><p><strong>Scenario:</strong> Operator suspects a machine might fail and wants to ensure preservation for analysis.</p><h4 id="steps-1" tabindex="-1">Steps: <a class="header-anchor" href="#steps-1" aria-label="Permalink to &quot;Steps:&quot;">​</a></h4><ol><li>Operator annotates node with <code>node.machine.sapcloud.io/preserve=when-failed</code>.</li><li>Machine fails later.</li><li>MCM preserves the machine.</li><li>Operator analyzes the VM.</li></ol><h3 id="use-case-3-auto-preservation" tabindex="-1">Use Case 3: Auto-Preservation <a class="header-anchor" href="#use-case-3-auto-preservation" aria-label="Permalink to &quot;Use Case 3: Auto-Preservation&quot;">​</a></h3><p><strong>Scenario:</strong> Machine fails unexpectedly, no prior annotation.</p><h4 id="steps-2" tabindex="-1">Steps: <a class="header-anchor" href="#steps-2" aria-label="Permalink to &quot;Steps:&quot;">​</a></h4><ol><li>Machine transitions to <code>Failed</code> phase.</li><li>Machine is drained.</li><li>If <code>autoPreserveFailedMax</code> is not breached, machine moved to <code>Failed:Preserved</code> phase by MCM.</li><li>After <code>machinePreserveTimeout</code>, machine is terminated by MCM.</li></ol><h3 id="use-case-4-early-release" tabindex="-1">Use Case 4: Early Release <a class="header-anchor" href="#use-case-4-early-release" aria-label="Permalink to &quot;Use Case 4: Early Release&quot;">​</a></h3><p><strong>Scenario:</strong> Operator has performed his analysis and no longer requires machine to be preserved.</p><h4 id="steps-3" tabindex="-1">Steps: <a class="header-anchor" href="#steps-3" aria-label="Permalink to &quot;Steps:&quot;">​</a></h4><ol><li>Machine is in <code>Running:Preserved</code> or <code>Failed:Preserved</code> phase.</li><li>Operator adds: <code>node.machine.sapcloud.io/preserve=false</code> to node.</li><li>MCM transitions machine to <code>Running</code> or <code>Terminating</code> for <code>Running:Preserved</code> or <code>Failed:Preserved</code> respectively, even though <code>machinePreserveTimeout</code> has not expired.</li><li>If machine was in <code>Failed:Preserved</code>, capacity becomes available for auto-preservation.</li></ol><h2 id="points-to-note" tabindex="-1">Points to Note <a class="header-anchor" href="#points-to-note" aria-label="Permalink to &quot;Points to Note&quot;">​</a></h2><ol><li>During rolling updates MCM will NOT honor preserving Machines. The Machine will be replaced with a healthy one if it moves to Failed phase.</li><li>Hibernation policy will override machine preservation.</li><li>Consumers (with access to shoot cluster) can annotate Nodes they would like to preserve.</li><li>Operators (with access to control plane) can additionally annotate Machines that they would like to preserve. This feature can be used when a Machine does not have a backing Node and the operator wishes to preserve the backing VM.</li><li>If the backing Node object exists but does not have the preservation annotation, preservation annotations added on the Machine will be honoured.</li><li>However, if a backing Node exists for a Machine and has the preservation annotation, the Node&#39;s annotation value will override the Machine annotation value, and be synced to the Machine object.</li><li>If <code>autoPreserveFailedMax</code> is reduced in the Shoot Spec, older machines are moved to <code>Terminating</code> phase before newer ones.</li><li>In case of a scale down of an MCD&#39;s replica count, <code>Preserved</code> machines will be the last to be scaled down. Replica count will always be honoured.</li><li>If the value for annotation key <code>cluster-autoscaler.kubernetes.io/scale-down-disabled</code> for a machine in <code>Running:Preserved</code> is changed to <code>false</code> by a user, the value will be overwritten to <code>true</code> by MCM.</li><li>On increase/decrease of timeout, the new value will only apply to machines that go into <code>Preserved</code> phase after the change. Operators can always edit <code>machine.CurrentStatus.PreserveExpiryTime</code> to prolong the expiry time of existing <code>Preserved</code> machines.</li><li><a href="https://github.com/gardener/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-can-i-prevent-cluster-autoscaler-from-scaling-down-a-particular-node" target="_blank" rel="noreferrer">Modify CA FAQ</a> once feature is developed to use <code>node.machine.sapcloud.io/preserve=now</code> instead of the <code>cluster-autoscaler.kubernetes.io/scale-down-disabled=true</code> currently suggested. This would:</li></ol><ul><li>harmonise machine flow</li><li>shield from CA&#39;s internals</li><li>make it generic and no longer CA specific</li><li>allow a timeout to be specified</li></ul>`,33)]))}const m=a(o,[["render",t]]);export{u as __pageData,m as default};
